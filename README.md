# Временные ряды. Сессионное задание
## Выполнил: Медведев Игорь Олегович НИЯУ МИФИ группа М24-525

## Постановка проекта
## Тема: «Телеграм-бот для анализа и прогнозирования акций на основе временных рядов».

## Цель проекта
### Проект направлен на разработку телеграм-бота, который позволяет пользователю получать прогноз цен акций и рекомендации по торговым стратегиям. Пользователь вводит название компании и сумму для условной инвестиции, бот автоматически загружает исторические данные о стоимости акций, обучает несколько моделей временных рядов, выбирает наилучшую по метрикам качества и строит прогноз на ближайшие 30 дней.

### В финале пользователь получает:

* график прогноза;
* оценку изменения цены акций относительно текущего дня;
* сводку с рекомендациями по дням покупки и продажи;
* расчёт потенциальной прибыли.
* Дополнительно бот ведёт журнал логов, где фиксируются все ключевые параметры каждого запроса.
* Бот не является финансовым инструментом, результаты носят исключительно учебный характер.

## @medved_finance_bot
# Телеграм-бот для прогнозирования биржевых данных

Телеграм-бот, который:
- загружает ~2 года исторических котировок из Yahoo Finance,
- обучает несколько моделей (Ridge, RandomForest, ARIMA, опционально LSTM),
- строит прогноз на рабочие дни,
- визуализирует все модели на одном графике,
- считает условную прибыль по простой стратегии и логирует результаты.

Основной упор — прогнозирование по рабочим дням (business days) и сравнение моделей на едином графике.

## Возможности

Команды:

/start — приветствие и краткая справка

/getdata — диалог: запрос тикера и суммы, сохранение CSV за ~2 года

/analyze <ТИКЕР> <СУММА> — обучение моделей, прогноз на 30 рабочих дней, график, метрики, условная прибыль

/cancel — отмена диалога

Поддержка пользовательских CSV (можно прислать .csv файлом боту)
Визуализация всех моделей на одном графике (лучшая помечена best)
Метрики качества (RMSE, MAPE)
Прогноз строится только по рабочим дням (без выходных)
Логи запусков в logs.txt



# Инструкции к боту

Ниже — краткая памятка по использованию бота для загрузки биржевых данных и построения прогноза на рабочие дни.

## Быстрый старт

Наберите команду:

/start — краткая справка

/getdata — начните диалог для загрузки данных

Следуйте шагам диалога /getdata:

Введите тикер (например, AAPL)

Укажите сумму (например, 1000)

После загрузки данных используйте:

/analyze AAPL 1000 — обучение моделей, прогноз на 30 рабочих дней, график, метрики и условная прибыль.

## Команды

/start — приветствие и краткая инструкция.
/getdata — диалог для загрузки ~2 лет котировок с Yahoo Finance по тикеру.
/analyze <ТИКЕР> <СУММА> — обучение моделей и прогноз на 30 рабочих дней, визуализация всех моделей.
/cancel — отмена текущего диалога (если вы в процессе /getdata).

## Дополнительно

Можно отправить свой CSV-файл с историей цен: бот сохранит файл и вы сможете затем запустить /analyze.

## Ввод данных

Тикер: латиница/цифры, точки и дефисы, 1–10 символов. Примеры: AAPL, MSFT, BRK.B, RDS-A.
Сумма: положительное число. Разрешены "." и "," как десятичный разделитель, например 1000 или 1,000.50.

Примеры:

/analyze AAPL 1000
/analyze MSFT 2500.5

## CSV от пользователя (опционально)

Отправьте боту файл .csv. Он будет сохранён в папке data/ и может использоваться в /analyze.
Требуется колонка даты и одна из ценовых колонок: Adj Close, Close или Price.
Дата должна быть формата YYYY-MM-DD. Порядок строк — неважен (бот сортирует сам).

## Что делает бот при анализе

Загружает вашу сохранённую историю цен (из шага /getdata или присланный CSV).
Обучает несколько моделей:

Ridge (авторегрессия на лагах)

RandomForestRegressor

ARIMA(1,1,1)

LSTM (если доступен PyTorch)

Сравнивает модели по RMSE и выбирает лучшую.
Строит прогноз на 30 рабочих дней вперед и рисует единый график:

История

Прогнозы всех моделей (лучший — выделен)

Присылает метрики всех моделей и краткую текстовую сводку.
Считает условную прибыль на прогнозном участке по простой стратегии:

Покупка на локальных минимумах и продажа на локальных максимумах (на моделируемом участке), без комиссий.

## Важно

Прогноз строится ровно по рабочим дням (без выходных) — используются business days.

## Как читать график

Синяя линия — исторические цены.
Цветные линии — прогнозы разных моделей на 30 рабочих дней.
Вертикальная пунктирная линия — граница между историей и прогнозом.
В легенде отмечено, какая модель оказалась лучшей (best).

# Архитектура

stage_1.py — бот, диалоги, загрузка данных из Yahoo Finance, подключение анализатора.
stage_2_5.py — обучение моделей, прогнозы, визуализация, стратегия, логирование и хэндлер /analyze.

Папка data/ используется для сохранения CSV пользователя:

user_<id>_<TICKER>_last_2y.csv — загруженные котировки
user_<id>_history_custom.csv — если пользователь прислал свой CSV

# Требования

### Python 3.10+
### Зависимости:
* pip install -r requirements.txt
## Укажите токен Telegram-бота в переменной TELEGRAM_BOT_TOKEN. 

# Формат CSV

Если отправляете свой CSV:

Нужна колонка даты (формат YYYY-MM-DD) и одна из: Adj Close, Close или Price.
Порядок строк не важен (бот отсортирует).
Индекс может быть в первой колонке (Date) — бот корректно распознаёт.

Пример минимального CSV:

Date,Close
2023-01-02,100.0
2023-01-03,101.2
...

# Модели и прогнозирование

Ridge (авторегрессия на лагах)
RandomForestRegressor
ARIMA(1, 1, 1)
LSTM (если доступен PyTorch)

Метрики: RMSE, MAPE (на последнем тестовом окне, по умолчанию 60 точек).

Прогноз строится по рабочим дням:

используется pandas.bdate_range,
для авторегрессии история расширяется шагами BusinessDay(1),
выходные исключены из индекса прогнозов.

# Визуализация

Единый график:

История — синяя линия
Прогнозы всех моделей — разными цветами и стилями, лучшая помечена “(best)” и рисуется толще
Вертикальная пунктирная линия — граница между историей и прогнозом
Заголовок отражает, что горизонт — в рабочих днях

Файл отправляется в чат как изображение.

# Условная стратегия

Простейшая стратегия на прогнозном участке:

покупка в локальных минимумах,
продажа в локальных максимумах,
без комиссий и проскальзываний.

Выводится список “сделок” и ориентировочная прибыль на указанную сумму.

Важно: это демонстрационная логика. Не является инвестиционной рекомендацией.

# Логирование

Каждый запуск /analyze логируется в logs.txt в формате:

YYYY-MM-DD HH:MM:SS UTC    user_id=...    ticker=...    amount=...    best_model=...    RMSE=...    MAPE=...    profit=...

# Структура проекта

.
* ├─ stage_1.py           # Telegram-бот, диалоги, загрузка данных, подключение анализатора
* ├─ stage_2_5.py         # Обучение моделей, прогнозы, визуализация, стратегия, логирование
* ├─ my_bot.env           # токен бота (не коммитьте публично)
* ├─ data/                # CSV пользователей
* ├─ logs.txt             # лог анализа
* └─ requirements.txt



















